<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pic-to-Vid æå…‰ç‰ˆ</title>
    <link rel="stylesheet" href="/static/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  </head>
  <body>
    <div class="main-container">
      <h1>PIC TO VIDEO</h1>

      <div class="glass-panel">
        <!-- ä¸Šä¼ åŒº -->
        <div class="upload-zone" id="dropZone">
          <div class="icon">ğŸ“‚</div>
          <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</p>
          <span class="sub-text"
            >æ”¯æŒ JPG, PNG, WEBP (ç‚¹å‡»ç¼©ç•¥å›¾å¯å…¨å±é¢„è§ˆ)</span
          >
          <input type="file" id="fileInput" multiple accept="image/*" hidden />
        </div>

        <!-- å‚æ•°è®¾ç½®æ  -->
        <div class="settings-bar">
          <div class="setting-item full-width">
            <label>è§†é¢‘æ ‡é¢˜</label>
            <input
              type="text"
              id="videoTitle"
              placeholder="è¾“å…¥è§†é¢‘åç§° (ä¾‹å¦‚: æ—…è¡Œå›å¿†)"
              value="My_Video"
            />
          </div>

          <div class="setting-item">
            <label>æ¯å¼ æ—¶é•¿: <span id="durationVal">2.0</span>s</label>
            <input
              type="range"
              id="durationRange"
              min="0.5"
              max="10.0"
              step="0.5"
              value="2.0"
            />
          </div>

          <div class="setting-item">
            <label>è§†é¢‘å°ºå¯¸</label>
            <select id="resSelect">
              <option value="portrait">ğŸ“± ç«–å± 9:16 (1080x1920)</option>
              <option value="landscape">ğŸ’» æ¨ªå± 16:9 (1920x1080)</option>
              <option value="square">ğŸ”² æ–¹å± 1:1 (1080x1080)</option>
            </select>
          </div>
        </div>

        <!-- å›¾ç‰‡åˆ—è¡¨ -->
        <div id="preview-list" class="grid-list"></div>

        <!-- è¿›åº¦æ¡ -->
        <div
          id="progressSection"
          class="progress-section"
          style="display: none"
        >
          <div class="progress-info">
            <span id="progressText">å‡†å¤‡ä¸­...</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="progress-track">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
          </div>
        </div>

        <div class="actions">
          <button id="clearBtn" class="btn secondary">æ¸…ç©º</button>
          <button id="generateBtn" class="btn primary">ç”Ÿæˆè§†é¢‘</button>
        </div>
      </div>
    </div>

    <!-- ç¯ç®± (å¤åˆ»è‡ª pic-to-book) -->
    <div id="lightbox" class="lightbox">
      <div class="lightbox-close">&times;</div>
      <div class="lightbox-nav prev" id="lb-prev">&#8249;</div>
      <div class="lightbox-nav next" id="lb-next">&#8250;</div>
      <div class="lightbox-content">
        <img id="lightbox-img" src="" alt="Preview" />
      </div>
      <div class="lightbox-counter" id="lb-counter">1 / 1</div>
    </div>

    <script>
      // DOM å…ƒç´ 
      const fileInput = document.getElementById("fileInput");
      const dropZone = document.getElementById("dropZone");
      const previewList = document.getElementById("preview-list");
      const generateBtn = document.getElementById("generateBtn");
      const clearBtn = document.getElementById("clearBtn");
      const durationRange = document.getElementById("durationRange");
      const durationVal = document.getElementById("durationVal");
      const resSelect = document.getElementById("resSelect");
      const videoTitle = document.getElementById("videoTitle");
      const progressSection = document.getElementById("progressSection");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      const progressPercent = document.getElementById("progressPercent");

      // ç¯ç®±å…ƒç´ 
      const lightbox = document.getElementById("lightbox");
      const lightboxImg = document.getElementById("lightbox-img");
      const lbPrev = document.getElementById("lb-prev");
      const lbNext = document.getElementById("lb-next");
      const lbCounter = document.getElementById("lb-counter");

      let fileStore = new Map();
      let uidCounter = 0;

      // ç¯ç®±çŠ¶æ€
      let currentImageIndex = 0;
      let currentImageList = [];

      // åˆå§‹åŒ–
      durationRange.addEventListener(
        "input",
        (e) => (durationVal.textContent = e.target.value)
      );

      new Sortable(previewList, {
        animation: 150,
        ghostClass: "sortable-ghost",
        onStart: () => (document.body.style.cursor = "grabbing"),
        onEnd: () => (document.body.style.cursor = "default"),
      });

      // --- æ–‡ä»¶å¤„ç† ---
      dropZone.onclick = () => fileInput.click();
      fileInput.onchange = (e) => handleFiles(e.target.files);

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("drag-over");
      });
      dropZone.addEventListener("dragleave", () =>
        dropZone.classList.remove("drag-over")
      );
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("drag-over");
        handleFiles(e.dataTransfer.files);
      });

      function handleFiles(files) {
        let landscapeCount = 0;
        let checkLimit = Math.min(files.length, 3);

        Array.from(files).forEach((file, index) => {
          if (!file.type.startsWith("image/")) return;

          const url = URL.createObjectURL(file);

          // å°ºå¯¸æ£€æµ‹
          const imgCheck = new Image();
          imgCheck.onload = function () {
            if (this.width > this.height && index < checkLimit)
              landscapeCount++;
            if (index === checkLimit - 1 && landscapeCount >= 2) {
              resSelect.value = "landscape";
            }
          };
          imgCheck.src = url;

          const uid = `img-${uidCounter++}`;
          fileStore.set(uid, file);

          // åˆ›å»ºå¡ç‰‡
          const card = document.createElement("div");
          card.className = "img-card";
          card.dataset.id = uid;

          const img = document.createElement("img");
          img.src = url;
          // ç‚¹å‡»è§¦å‘ç¯ç®±
          img.onclick = (e) => {
            e.stopPropagation();
            openGallery(url);
          };

          const delBtn = document.createElement("div");
          delBtn.className = "del-btn";
          delBtn.innerHTML = "Ã—";
          delBtn.onclick = (e) => {
            e.stopPropagation();
            fileStore.delete(uid);
            card.remove();
          };

          card.appendChild(img);
          card.appendChild(delBtn);
          previewList.appendChild(card);
        });
      }

      clearBtn.onclick = () => {
        fileStore.clear();
        previewList.innerHTML = "";
        progressSection.style.display = "none";
      };

      // --- ç¯ç®±é€»è¾‘ (å¤åˆ»ç‰ˆ) ---
      function openGallery(targetUrl) {
        const domImages = previewList.querySelectorAll(".img-card img");
        if (domImages.length === 0) return;

        currentImageList = Array.from(domImages).map((img) => img.src);
        currentImageIndex = currentImageList.indexOf(targetUrl);
        if (currentImageIndex === -1) currentImageIndex = 0;

        updateLightbox();
        lightbox.classList.add("active");
        document.addEventListener("keydown", handleKeyboard);
      }

      function closeGallery() {
        lightbox.classList.remove("active");
        document.removeEventListener("keydown", handleKeyboard);
      }

      function updateLightbox() {
        lightboxImg.style.opacity = "0.5";
        setTimeout(() => {
          lightboxImg.src = currentImageList[currentImageIndex];
          lightboxImg.style.opacity = "1";
        }, 100);
        lbCounter.textContent = `${currentImageIndex + 1} / ${
          currentImageList.length
        }`;
      }

      function nextImage(e) {
        if (e) e.stopPropagation();
        currentImageIndex = (currentImageIndex + 1) % currentImageList.length;
        updateLightbox();
      }

      function prevImage(e) {
        if (e) e.stopPropagation();
        currentImageIndex =
          (currentImageIndex - 1 + currentImageList.length) %
          currentImageList.length;
        updateLightbox();
      }

      function handleKeyboard(e) {
        if (e.key === "ArrowRight") nextImage();
        if (e.key === "ArrowLeft") prevImage();
        if (e.key === "Escape") closeGallery();
      }

      document.querySelector(".lightbox-close").onclick = closeGallery;
      lightbox.onclick = (e) => {
        if (e.target === lightbox) closeGallery();
      };
      lbNext.onclick = nextImage;
      lbPrev.onclick = prevImage;

      // --- ç”Ÿæˆé€»è¾‘ ---
      generateBtn.onclick = async () => {
        if (fileStore.size === 0) return alert("è¯·å…ˆä¸Šä¼ å›¾ç‰‡");

        const title = videoTitle.value.trim() || "My_Video";

        const formData = new FormData();
        formData.append("title", title);
        formData.append("duration", durationRange.value);
        formData.append("resolution", resSelect.value); // ç¡®ä¿ä¼ å€¼

        const cards = previewList.querySelectorAll(".img-card");
        cards.forEach((card) => {
          const uid = card.dataset.id;
          if (fileStore.get(uid)) formData.append("files", fileStore.get(uid));
        });

        generateBtn.disabled = true;
        progressSection.style.display = "block";
        updateProgress(0, "æ­£åœ¨ä¸Šä¼ ...");

        try {
          const uploadRes = await fetch("/upload", {
            method: "POST",
            body: formData,
          });
          if (!uploadRes.ok) throw new Error("ä¸Šä¼ å¤±è´¥");
          const { task_id } = await uploadRes.json();

          const poll = setInterval(async () => {
            try {
              const statusRes = await fetch(`/status/${task_id}`);
              const statusData = await statusRes.json();

              if (statusData.status === "processing") {
                updateProgress(statusData.percent, statusData.msg);
              } else if (statusData.status === "completed") {
                clearInterval(poll);
                updateProgress(100, "ç”Ÿæˆå®Œæˆï¼Œæ­£åœ¨ä¸‹è½½...");
                window.location.href = `/download/${task_id}`;
                setTimeout(() => {
                  generateBtn.disabled = false;
                  generateBtn.textContent = "ç”Ÿæˆè§†é¢‘";
                }, 1000);
              } else {
                clearInterval(poll);
                alert("ç”Ÿæˆå¤±è´¥: " + statusData.msg);
                generateBtn.disabled = false;
              }
            } catch (e) {
              console.error(e);
            }
          }, 1000);
        } catch (err) {
          alert(err.message);
          generateBtn.disabled = false;
        }
      };

      function updateProgress(percent, text) {
        progressBar.style.width = `${percent}%`;
        progressPercent.textContent = `${percent}%`;
        progressText.textContent = text;
      }
    </script>
  </body>
</html>
